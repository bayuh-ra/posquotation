<!-- quotation.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="backend/config.js"></script>
    <script src="backend/supabase.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotation - LAP I.T. Solutions</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="styles/quotation.css">
    
    <style>
        /* Mobile responsive button styles */
        .no-print {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .button-container {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .button-container button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
            min-width: 120px;
            max-width: 200px;
            transition: all 0.3s;
        }
        
        .button-container button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        @media (max-width: 768px) {
            .button-container {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
            
            .button-container button {
                flex: 1;
                min-width: 100px;
                max-width: none;
                font-size: 12px;
                padding: 10px 15px;
                white-space: nowrap;
            }
        }
        
        .add-product-btn {
            margin-top: 20px;
            text-align: center;
        }
        
        .add-product-btn button {
            background: #667eea;
            color: white;
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .add-product-btn button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        /* Delete Confirmation Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 0;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideDown 0.3s;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px;
            background-color: #dc3545;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-body {
            padding: 30px 20px;
            text-align: center;
            font-size: 14px;
            color: #333;
        }
        
        .modal-footer {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #dee2e6;
        }
        
        .modal-footer button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-cancel {
            background: #6c757d;
            color: white;
        }
        
        .btn-cancel:hover {
            background: #5a6268;
        }
        
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c82333;
        }
        
        /* PDF Preview Modal */
        .pdf-preview-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            animation: fadeIn 0.3s;
        }
        
        .pdf-preview-content {
            background-color: #fff;
            margin: 2% auto;
            padding: 0;
            width: 95%;
            height: 95%;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .pdf-preview-header {
            padding: 15px 20px;
            background-color: #1a5276;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pdf-preview-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: bold;
        }
        
        .close-preview {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .close-preview:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .pdf-preview-body {
            flex: 1;
            overflow: auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .pdf-preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .pdf-preview-footer {
            padding: 15px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            border-top: 1px solid #dee2e6;
            background: white;
            border-radius: 0 0 8px 8px;
        }
        
        .pdf-preview-footer button {
            padding: 10px 30px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-close-preview {
            background: #6c757d;
            color: white;
        }
        
        .btn-close-preview:hover {
            background: #5a6268;
        }
        
        .btn-download-pdf {
            background: #28a745;
            color: white;
        }
        
        .btn-download-pdf:hover {
            background: #218838;
        }
    </style>
</head>
<body>
    <!-- No-print buttons at the top -->
    <div class="no-print">
        <div class="button-container">
            <button onclick="goBack()" style="background: #6c757d; color: white;">
                ‚Üê Back to Home
            </button>
            <button onclick="saveQuotation()" style="background: #1a5276; color: white;">
                Save Quotation
            </button>
            <button onclick="window.print()" style="background: #28a745; color: white;">
                Save as PDF
            </button>
        </div>
    </div>

    <div id="pdf-content">
        <!-- PAGE 1 -->
        <div class="page">
            <!-- Header -->
            <div class="header" style="align-items: flex-start;">
                <div style="display: flex; flex-direction: column; align-items: center; margin-right: 15px; width: 130px; flex-shrink: 0;">
                    <img src="LOGO1.png" alt="LAP I.T. Solutions Logo" style="height: 130px; width: 130px; object-fit: contain;">
                </div>
                <div class="company-info" style="display: flex; align-items: flex-start; padding-top: 38px;">
                    <div class="company-contact" style="line-height: 1.4; font-family: 'Arial', sans-serif; font-size: 10px; font-weight: normal; color: #000;">
                        <div>Door B-3 Marcela Building 11-A, J.Palma Gil Street, Davao<br>City, Philippines, 8000</div>
                        <div>Landline: (082) 296-0363  Mobile: 0905-5565713</div>
                        <div>Email: <a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="f39f92839a87809c9f86879a9c9d809a9d909c81839c8192879697b3949e929a9fdd909c9e">[email&#160;protected]</a></div>
                    </div>
                </div>
                <div class="quotation-title">
                    <h1></h1>
                </div>
            </div>
            
            <!-- Client & Quotation Info -->
            <div class="info-section">
                <div class="client-info">
                    <div class="info-row">
                        <span class="info-label">To:</span>
                        <input type="text" class="info-value border border-gray-300 rounded px-2 py-1" style="width: 180px;" placeholder="Enter recipient name">
                    </div>
                    <div class="info-row">
                        <span class="info-label">Office Address:</span>
                        <input type="text" class="info-value border border-gray-300 rounded px-2 py-1" style="width: 180px;" placeholder="Enter office address">
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contact Person:</span>
                        <input type="text" class="info-value border border-gray-300 rounded px-2 py-1" style="width: 180px;" placeholder="Enter contact person">
                    </div>
                    <div class="info-row">
                        <span class="info-label">Contact No:</span>
                        <input type="text" class="info-value border border-gray-300 rounded px-2 py-1" style="width: 180px;" placeholder="Enter contact number">
                    </div>
                </div>
                <div class="quote-info" style="text-align: right;">
                    <div style="font-size: 14px; font-weight: bold; color: #1a5276; font-family: 'Arial', sans-serif;">
                        <div>QUOTATION NO.: <span id="quote-number"></span></div>
                        <div>DATE: <span id="quote-date"></span></div>
                    </div>
                </div>
            </div>
            
            <!-- Items Table -->
            <table>
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Qty.</th>
                        <th>Unit</th>
                        <th>Description</th>
                        <th>Price (Php)</th>
                        <th>Total (Php)</th>
                        <th class="no-print" style="width: 60px;">Action</th>
                    </tr>
                </thead>
                <tbody id="quotation-tbody">
                    <!-- First Row: Package Type and Description -->
                    <tr id="package-type-row">
                        <td rowspan="2" style="vertical-align: top; font-weight: bold;">
                            <select id="packageType" style="font-weight: bold; font-size: 9px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; width: 100%;">
                                <option value="" selected disabled>Select package type</option>
                            </select>
                        </td>
                        <td><input type="number" value="1" min="0" class="qty-input" style="width: 50px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                        <td><input type="text" class="unit-display" readonly style="font-size: 10px; padding: 2px 4px; border: 1px solid #e0e0e0; border-radius: 3px; background: #f5f5f5; width: 100%; text-align: center;"></td>
                        <td>
                            <select id="descriptionDropdown" style="font-weight: bold; font-size: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; width: 100%;">
                                <option value="" selected disabled>Select description</option>
                            </select>
                            <div id="typeInclusions" style="margin-top: 6px; font-size: 10px; color: #1976d2; font-style: italic;">Inclusions for selected type will appear here.</div>
                        </td>
                        <td><input type="number" class="price-input" value="" step="0.01" style="width: 80px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                        <td class="total-cell" style="text-align: right; font-weight: bold;">‚Ç±0.00</td>
                        <td class="no-print"></td>
                    </tr>
                    
                    <!-- Second Row: First Product -->
                    <tr class="product-row">
                        <td><input type="number" value="0" min="0" class="qty-input" style="width: 50px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                        <td><input type="text" class="unit-display" readonly style="font-size: 10px; padding: 2px 4px; border: 1px solid #e0e0e0; border-radius: 3px; background: #f5f5f5; width: 100%; text-align: center;"></td>
                        <td>
                            <select class="product-dropdown" style="font-weight: bold; font-size: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; width: 100%;">
                                <option value="" selected disabled>Select product</option>
                            </select>
                        </td>
                        <td><input type="number" class="price-input" value="" step="0.01" style="width: 80px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                        <td class="total-cell" style="text-align: right; font-weight: bold;">‚Ç±0.00</td>
                        <td class="no-print"><button onclick="deleteRow(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">Delete</button></td>
                    </tr>
                    
                    <!-- Delivery Row (Always at bottom) -->
                    <tr id="delivery-row">
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <div style="font-style: italic;">
                                <strong>Delivery, setup, installation, and training;</strong><br>
                                <strong>Guaranteed (1) year technical support</strong><br>
                                Via text, call and remote access
                            </div>
                        </td>
                        <td><input type="number" class="delivery-price-input" value="0" step="0.01" placeholder="0 = FREE" style="width: 80px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                        <td class="delivery-total-cell" style="text-align: right; font-weight: bold; color: #28a745;">FREE</td>
                        <td class="no-print"></td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr style="background: #d6e6f0;">
                        <td colspan="5" style="text-align: right; font-weight: bold; padding: 10px;">Subtotal (including delivery)</td>
                        <td id="subtotal-cell" style="text-align: right; font-weight: bold; padding: 10px;">‚Ç±0.00</td>
                        <td class="no-print"></td>
                    </tr>
                    <tr style="background: #d6e6f0;">
                        <td colspan="5" style="text-align: right; font-weight: bold; padding: 10px;">Total Package Price</td>
                        <td id="discounted-price-cell" style="text-align: right; font-weight: bold; padding: 10px;">‚Ç±0.00</td>
                        <td class="no-print"></td>
                    </tr>
                </tfoot>
            </table>
            
            <!-- Add Product Button -->
            <div class="no-print add-product-btn">
                <button onclick="addProductRow()">+ Add Another Product</button>
            </div>
        </div>
        
        <!-- PAGE 2 -->
        <div class="page page-break">
            <!-- Terms and Conditions -->
            <div class="terms-section">
                <h3 style="font-weight: bold; margin-bottom: 12px; font-size: 13px; color: #000;">Terms and Conditions:</h3>
                <ol class="terms-list" style="margin-left: 25px; font-size: 11px; color: #000; font-weight: 500;">
                    <li style="margin-bottom: 3px;">Payment Terms:
                        <div style="margin-left: 40px; margin-top: 3px;">
                            <strong>‚Ç±35,000</strong> down payment (non refundable) upon confirmation of order<br>
                            <strong>‚Ç±35,000</strong> upon delivery and completion<br>
                            <strong>‚Ç±26,000</strong> upon delivery and completion (30 days PDC)
                        </div>
                        <div style="margin-left: 15px; margin-top: 5px;">
                            For check payments, please make check payable to <strong><em>LAP I.T. SOLUTIONS</em></strong>
                        </div>
                    </li>
                    <li style="margin-bottom: 3px;">All prices quoted are valid for 7 days from the date of quotation.</li>
                    <li style="margin-bottom: 3px;">Grand Total is <strong>VAT exclusive.</strong></li>
                    <li style="margin-bottom: 3px;">Initial, partial and down payments are considered binding and non-refundable.</li>
                    <li style="margin-bottom: 3px;">For Davao City clients, delivery of goods and services will be 3 to 5 days upon date of down payment.</li>
                    <li style="margin-bottom: 3px;">For clients outside Davao City, delivery of goods and services will be 5 to 7 days upon date of down payment. Delivery and other related expenses will be shouldered by the client.</li>
                    <li style="margin-bottom: 3px;">Internet Connection is required for license activation and online support purposes.</li>
                    <li style="margin-bottom: 3px;">Any fortuitous event may void the warranty. However, certain consideration will be given to the client.</li>
                    <li style="margin-bottom: 3px;">Any form of hacking or cracking of our software may void the contract.</li>
                    <li style="margin-bottom: 3px;">If within Davao City, on site visit will be conducted 1 to 3 business days upon request.</li>
                    <li style="margin-bottom: 3px;">If outside Davao City, on site visit will be 3 to 10 business days upon request and all expenses such as transportation, accommodation and other related cost must be shouldered by the client.</li>
                    <li style="margin-bottom: 3px;">LAP I.T. Solutions may ask the client to provide some documents (hard or soft copy) to complete the implementation.</li>
                    <li style="margin-bottom: 3px;">Customization and system enhancement is not included in the quotation therefore, charges may apply.</li>
                    <li style="margin-bottom: 3px;">The aforementioned POS package is covered by hardware warranty for a period of twelve (12) months from date of delivery. The provision of this warranty and maintenance shall not cover direct or indirect loss of the unit resulting from any of the following:
                        <div style="margin-left: 40px; margin-top: 5px;">
                            14.1 Normal wear and tear, improper use of the unit and in-adherence to prescribed<br>
                            <span style="margin-left: 28px;">instructions for normal operation and maintenance of the unit;</span><br>
                            14.2 Faulty electrical wiring and improper grounding within the buyer's premises;<br>
                            14.3 Power fluctuation, operating the unit outside its required power input;<br>
                            14.4 Negligence, tampering and/or unauthorized repair of the unit;<br>
                            14.5 Lightning, flood, fire, accident or other fortuitous events;<br>
                            14.6 Unauthorized installation;<br>
                            14.7 Tampering or removing of sticker, altered or obliterated.
                        </div>
                    </li>
                </ol>
                
                <p style="font-weight: bold; margin-top: 15px; margin-bottom: 8px; font-size: 11px; color: #000;">Support & Warranty:</p>
                <ul style="margin-left: 25px; font-size: 11px; color: #000; list-style-type: circle; font-weight: 500;">
                    <li style="margin-bottom: 8px;">Guaranteed Technical support for 12 months via text message, voice call, email, chat via messenger and online support via anydesk or teamviewer.</li>
                    <li style="margin-bottom: 8px;">After one (1) year, client is encourage to pay ‚Ç±1,000/month for continued technical support</li>
                    <li style="margin-bottom: 8px;">Software use is covered by Service License Agreement (SLA) and End User License Agreement (EULA).</li>
                </ul>
                
                <p style="margin-top: 15px; font-size: 11px; color: #000; font-weight: 500;">Our warranty is absolutely limited to the specified parts and services mentioned above.</p>
                
                <p style="margin-top: 15px; font-size: 11px; color: #000; font-weight: 500;">This document serves as a contract agreement as well as acknowledgement receipt. If all is in order, kindly sign Below.</p>
            </div>
            
            <!-- Signature Section -->
            <div class="signature-section" style="margin-top: 25px;">
                <div style="display: flex; align-items: flex-end;">
                    <p style="font-weight: bold; font-size: 11px; color: #000; margin: 0; margin-right: 15px; padding-bottom: 20px;">CONFORME:</p>
                    <div>
                        <div style="width: 200px; border-bottom: 1px solid #000; margin-bottom: 3px;"></div>
                        <div style="font-size: 10px; color: #000; text-align: center;">Signature over Printed Name</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal no-print">
        <div class="modal-content">
            <div class="modal-header">
                <span style="font-size: 24px;">‚ö†Ô∏è</span>
                <h2>Confirm Delete</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product row?</p>
                <p style="color: #666; font-size: 12px; margin-top: 10px;">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeDeleteModal()">Cancel</button>
                <button class="btn-delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Scripts - Load in correct order -->
    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="backend/supabase.js"></script>
    <script src="scripts/quotation.js"></script>
    
    <script>
        function goBack() {
            // Check if we came from the quotations list
            const referrer = document.referrer;
            if (referrer.includes('quotationlist.html')) {
                window.location.href = 'quotationlist.html';
            } else {
                window.location.href = 'home.html';
            }
        }
        
        // Add product row function
        async function addProductRow() {
            const tbody = document.getElementById('quotation-tbody');
            const deliveryRow = document.getElementById('delivery-row');
            
            const newRow = document.createElement('tr');
            newRow.className = 'product-row';
            
            newRow.innerHTML = `
                <td></td>
                <td><input type="number" value="0" min="0" class="qty-input" style="width: 50px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                <td><input type="text" class="unit-display" readonly style="font-size: 10px; padding: 2px 4px; border: 1px solid #e0e0e0; border-radius: 3px; background: #f5f5f5; width: 100%; text-align: center;"></td>
                <td>
                    <select class="product-dropdown" style="font-weight: bold; font-size: 10px; padding: 5px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; width: 100%;">
                        <option value="" selected disabled>Select product</option>
                    </select>
                </td>
                <td><input type="number" class="price-input" value="" step="0.01" style="width: 80px; font-size: 10px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; text-align: right;"></td>
                <td class="total-cell" style="text-align: right; font-weight: bold;">‚Ç±0.00</td>
                <td class="no-print"><button onclick="deleteRow(this)" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">Delete</button></td>
            `;
            
            // Insert before the delivery row
            tbody.insertBefore(newRow, deliveryRow);
            
            // Populate the new product dropdown with current package's products (excluding License)
            await populateNewProductDropdown(newRow.querySelector('.product-dropdown'), true);
            
            // Add event listeners
            setupRowEventListeners(newRow);
            
            // Enable text wrapping after selection for the new product dropdown
            const newDropdown = newRow.querySelector('.product-dropdown');
            if (newDropdown && typeof handleDropdownSelection === 'function') {
                handleDropdownSelection(newDropdown);
            }
        }
        
        // Delete row function
        let rowToDelete = null;
        
        function deleteRow(button) {
            rowToDelete = button.closest('tr');
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            rowToDelete = null;
        }
        
        function confirmDelete() {
            if (rowToDelete) {
                rowToDelete.remove();
                calculateTotals();
                closeDeleteModal();
            }
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target === modal) {
                closeDeleteModal();
            }
        }
        
        async function populateNewProductDropdown(dropdown) {
            // Fetch ALL products from database (not just package products)
            const allProducts = await getProducts();
            
            dropdown.innerHTML = '<option value="" selected disabled>Select product</option>';
            
            if (allProducts && allProducts.length > 0) {
                // Filter to only show non-License products
                const filteredProducts = allProducts.filter(product => {
                    if (!product.unit) return false;
                    return product.unit.toLowerCase() !== 'license';
                });
                
                filteredProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.name;
                    option.textContent = product.name;
                    
                    // Set product data
                    option.dataset.unit = product.unit || '';
                    option.dataset.price = product.base_price || 0;
                    option.dataset.description = product.description || '';
                    
                    dropdown.appendChild(option);
                });
            }
        }
        
        function populateUnitSelect(select) {
            select.innerHTML = '<option value="" selected disabled>Select</option>';
            if (units && units.length > 0) {
                units.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.name || u.code || u;
                    opt.textContent = u.name || u.label || opt.value;
                    select.appendChild(opt);
                });
            }
        }
        
        function setupRowEventListeners(row) {
            const productDropdown = row.querySelector('.product-dropdown');
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');
            
            if (productDropdown) {
                productDropdown.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    
                    // Auto-set quantity to 1 when product is selected
                    const qtyInput = row.querySelector('.qty-input');
                    if (qtyInput && parseFloat(qtyInput.value) === 0) {
                        qtyInput.value = 1;
                    }
                    
                    // Set unit display (read-only text)
                    const unitDisplay = row.querySelector('.unit-display');
                    if (unitDisplay && selectedOption.dataset.unit) {
                        unitDisplay.value = selectedOption.dataset.unit;
                    }
                    
                    // Set price (but keep it editable)
                    if (priceInput && selectedOption.dataset.price) {
                        priceInput.value = selectedOption.dataset.price;
                    }
                    
                    calculateRowTotal(row);
                    calculateTotals();
                });
            }
            
            if (qtyInput) {
                qtyInput.addEventListener('input', function() {
                    calculateRowTotal(row);
                    calculateTotals();
                });
            }
            
            if (priceInput) {
                priceInput.addEventListener('input', function() {
                    calculateRowTotal(row);
                    calculateTotals();
                });
            }
        }
        
        // Calculate total for a single row
        function calculateRowTotal(row) {
            const qtyInput = row.querySelector('.qty-input');
            const priceInput = row.querySelector('.price-input');
            const totalCell = row.querySelector('.total-cell');
            
            if (qtyInput && priceInput && totalCell) {
                const qty = parseFloat(qtyInput.value) || 0;
                const price = parseFloat(priceInput.value) || 0;
                const total = qty * price;
                
                totalCell.textContent = '‚Ç±' + total.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }
        
        // ==========================================
        // VIEW MODE FUNCTIONALITY
        // ==========================================
        
        // Check if we're in view mode when page loads
        window.addEventListener('DOMContentLoaded', function() {
            const viewMode = localStorage.getItem('viewMode');
            const quotationData = localStorage.getItem('viewQuotationData');
            
            if (viewMode === 'true' && quotationData) {
                try {
                    const quotation = JSON.parse(quotationData);
                    loadQuotationInViewMode(quotation);
                    
                    // Clear the flags
                    localStorage.removeItem('viewMode');
                    localStorage.removeItem('viewQuotationData');
                } catch (error) {
                    console.error('Error loading view mode:', error);
                }
            }
        });
        
        // Function to load quotation in view-only mode
        async function loadQuotationInViewMode(quotation) {
            console.log('Loading quotation in view mode:', quotation);
            console.log('Quotation ID:', quotation.id);
            console.log('Package Type:', quotation.package_type);
            console.log('All quotation fields:', Object.keys(quotation));
            
            // Populate client information
            const clientInputs = document.querySelectorAll('.client-info input');
            if (clientInputs[0]) clientInputs[0].value = quotation.client_name || '';
            if (clientInputs[1]) clientInputs[1].value = quotation.office_address || '';
            if (clientInputs[2]) clientInputs[2].value = quotation.contact_person || '';
            if (clientInputs[3]) clientInputs[3].value = quotation.contact_number || '';
            
            // Populate quotation number and date
            const quoteNumber = document.getElementById('quote-number');
            const quoteDate = document.getElementById('quote-date');
            if (quoteNumber) quoteNumber.textContent = quotation.quotation_no || '';
            if (quoteDate) {
                const date = quotation.quotation_date || quotation.created_at;
                if (date) {
                    const formatted = new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                    quoteDate.textContent = formatted;
                }
            }
            
            // LOAD QUOTATION ITEMS WITH PRODUCT DATA USING JOIN
            try {
                const { data: items, error } = await supabaseClient
                    .from('quotation_items')
                    .select(`
                        *,
                        product:products(
                            id,
                            name,
                            description,
                            unit,
                            base_price
                        )
                    `)
                    .eq('quotation_id', quotation.id)
                    .order('row_order', { ascending: true });
                
                if (error) {
                    console.error('Error loading quotation items:', error);
                    alert('Error loading quotation items: ' + error.message);
                } else if (items && items.length > 0) {
                    console.log('Loaded items with products:', items);
                    console.log('Quotation package_type:', quotation.package_type);
                    
                    // Pass package_type to populate function (with fallback)
                    const packageType = quotation.package_type || 'Basic POS Package';
                    console.log('Using package type:', packageType);
                    populateQuotationItems(items, packageType);
                } else {
                    console.log('No items found for this quotation');
                    alert('No items found for this quotation.');
                }
            } catch (error) {
                console.error('Error fetching items:', error);
                alert('Error fetching items: ' + error.message);
            }
            
            // Make page read-only
            makePageReadOnly();
        }
        
        // Function to populate the quotation items in the table
        function populateQuotationItems(items, packageType) {
            const tbody = document.getElementById('quotation-tbody');
            if (!tbody) {
                console.error('Table body not found');
                return;
            }
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            let isFirstProductRow = true; // Track if this is the first product (second row of package)
            
            items.forEach((item, index) => {
                console.log('Processing item', index, ':', item);
                
                if (item.row_type === 'package') {
                    // Create package type row
                    const packageRow = document.createElement('tr');
                    packageRow.id = 'package-type-row';
                    
                    // Check if this is NEW structure (with product_id) or OLD structure (without)
                    const hasProductData = item.product && item.product.name;
                    
                    // Get product data
                    let productName, productDescription, unit;
                    
                    if (hasProductData) {
                        // NEW structure: use data from product join
                        productName = item.product.name;
                        productDescription = item.product.description || '';
                        unit = item.product.unit || '';
                    } else {
                        // OLD structure: use data saved in quotation_items
                        productName = item.product_name || 'Unknown Product';
                        productDescription = item.description || '';
                        unit = item.unit || '';
                    }
                    
                    // Format description: Product Name (bold) + bullet points
                    let descriptionContent = '';
                    if (productName || productDescription) {
                        // Product name as first line (bold)
                        descriptionContent = `<div style="font-weight: bold; font-size: 10px; padding: 5px 5px 2px 5px;">${productName}</div>`;
                        
                        // Add description with bullet points if available
                        if (productDescription) {
                            const lines = productDescription.split('\n').filter(line => line.trim());
                            if (lines.length > 0) {
                                descriptionContent += '<div style="font-size: 9px; color: #666; padding: 2px 5px;">';
                                lines.forEach(line => {
                                    descriptionContent += `<div style="margin-bottom: 2px;">‚úì ${line.trim()}</div>`;
                                });
                                descriptionContent += '</div>';
                            }
                        }
                    }
                    
                    packageRow.innerHTML = `
                        <td rowspan="2" style="vertical-align: top; font-weight: bold; font-size: 10px; padding: 8px;">
                            ${packageType || 'Package'}
                        </td>
                        <td><input type="number" value="${item.quantity}" disabled class="qty-input" style="width: 50px; font-size: 10px; padding: 2px 4px; text-align: right;"></td>
                        <td><input type="text" value="${unit}" disabled class="unit-display" readonly style="font-size: 10px; padding: 2px 4px; width: 100%; text-align: center;"></td>
                        <td>
                            ${descriptionContent}
                        </td>
                        <td><input type="number" value="${item.price}" disabled class="price-input" style="width: 80px; font-size: 10px; padding: 2px 4px; text-align: right;"></td>
                        <td class="total-cell" style="text-align: right; font-weight: bold;">‚Ç±${parseFloat(item.total).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="no-print"></td>
                    `;
                    tbody.appendChild(packageRow);
                    
                } else if (item.row_type === 'product') {
                    // Create product row
                    const productRow = document.createElement('tr');
                    productRow.className = 'product-row';
                    
                    // Check if this is NEW structure (with product_id) or OLD structure (without)
                    const hasProductData = item.product && item.product.name;
                    
                    // Get product data
                    let productName, productDescription, unit;
                    
                    if (hasProductData) {
                        // NEW structure: use data from product join
                        productName = item.product.name;
                        productDescription = item.product.description || '';
                        unit = item.product.unit || '';
                    } else {
                        // OLD structure: use data saved in quotation_items
                        productName = item.product_name || 'Unknown Product';
                        productDescription = item.description || '';
                        unit = item.unit || '';
                    }
                    
                    // Format description with bullet points
                    let descriptionHTML = '';
                    if (productDescription) {
                        const lines = productDescription.split('\n').filter(line => line.trim());
                        if (lines.length > 1) {
                            descriptionHTML = '<div style="font-size: 9px; color: #666; margin-top: 4px;">';
                            lines.forEach(line => {
                                descriptionHTML += `<div style="margin-bottom: 2px;">‚úì ${line.trim()}</div>`;
                            });
                            descriptionHTML += '</div>';
                        } else if (productDescription.trim()) {
                            descriptionHTML = `<div style="font-size: 9px; color: #666; margin-top: 4px;">${productDescription}</div>`;
                        }
                    }
                    
                    // First product row doesn't have empty <td> because package type has rowspan="2"
                    // All other product rows need empty <td> for the Type column
                    const firstColumnHTML = isFirstProductRow ? '' : '<td></td>';
                    // Remove indentation - all products should align the same
                    isFirstProductRow = false;
                    
                    productRow.innerHTML = `
                        ${firstColumnHTML}
                        <td><input type="number" value="${item.quantity}" disabled class="qty-input" style="width: 50px; font-size: 10px; padding: 2px 4px; text-align: right;"></td>
                        <td><input type="text" value="${unit}" disabled class="unit-display" readonly style="font-size: 10px; padding: 2px 4px; width: 100%; text-align: center;"></td>
                        <td>
                            <div style="font-weight: bold; font-size: 10px; padding: 5px;">${productName}</div>
                            ${descriptionHTML}
                        </td>
                        <td><input type="number" value="${item.price}" disabled class="price-input" style="width: 80px; font-size: 10px; padding: 2px 4px; text-align: right;"></td>
                        <td class="total-cell" style="text-align: right; font-weight: bold;">‚Ç±${parseFloat(item.total).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="no-print"></td>
                    `;
                    tbody.appendChild(productRow);
                    
                } else if (item.row_type === 'delivery') {
                    // Create delivery row (delivery has no product)
                    const deliveryRow = document.createElement('tr');
                    deliveryRow.id = 'delivery-row';
                    const isFree = parseFloat(item.price) === 0 || parseFloat(item.total) === 0;
                    
                    deliveryRow.innerHTML = `
                        <td></td>
                        <td></td>
                        <td></td>
                        <td>
                            <div style="font-style: italic;">
                                <strong>Delivery, setup, installation, and training</strong><br>
                                <strong>Guaranteed (1) year technical support via text, call and remote access</strong><br>
                                Via text, call and remote access
                            </div>
                        </td>
                        <td><input type="number" value="${item.price}" disabled class="delivery-price-input" style="width: 80px; font-size: 10px; padding: 2px 4px; text-align: right;"></td>
                        <td class="delivery-total-cell" style="text-align: right; font-weight: bold; color: ${isFree ? '#28a745' : '#000'};">${isFree ? 'FREE' : '‚Ç±' + parseFloat(item.total).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="no-print"></td>
                    `;
                    tbody.appendChild(deliveryRow);
                }
            });
            
            // Update totals
            const subtotal = items.reduce((sum, item) => sum + (parseFloat(item.total) || 0), 0);
            const subtotalCell = document.getElementById('subtotal-cell');
            const discountedCell = document.getElementById('discounted-price-cell');
            
            if (subtotalCell) {
                subtotalCell.textContent = '‚Ç±' + subtotal.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            if (discountedCell) {
                discountedCell.textContent = '‚Ç±' + subtotal.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
            
            console.log('Finished populating', items.length, 'items. Subtotal:', subtotal);
        }
        
        // Function to make entire page read-only
        function makePageReadOnly() {
            // Add visual indicator banner
            const buttonContainer = document.querySelector('.button-container');
            if (buttonContainer) {
                const viewBanner = document.createElement('div');
                viewBanner.className = 'no-print';
                viewBanner.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; padding: 15px; margin-bottom: 20px; text-align: center; font-weight: bold; color: #856404; border-radius: 8px; font-size: 16px;';
                viewBanner.innerHTML = 'üîí VIEW MODE - This quotation is read-only. You can only print or save as PDF.';
                buttonContainer.parentNode.insertBefore(viewBanner, buttonContainer);
            }
            
            // Update "Save Quotation" button
            const buttons = document.querySelectorAll('.button-container button');
            if (buttons[1]) { // Second button is "Save Quotation"
                buttons[1].textContent = 'üîí View Mode (Read Only)';
                buttons[1].style.background = '#6c757d';
                buttons[1].style.cursor = 'not-allowed';
                buttons[1].onclick = function(e) {
                    e.preventDefault();
                    alert('This quotation is in view-only mode. You cannot make changes.');
                    return false;
                };
            }
            
            // Change "Back" button text to "Back to List"
            if (buttons[0]) {
                buttons[0].textContent = '‚Üê Back to List';
            }
            
            // Disable all inputs and selects
            const allInputs = document.querySelectorAll('input, select, textarea');
            allInputs.forEach(input => {
                input.disabled = true;
                input.style.cursor = 'not-allowed';
                input.style.opacity = '0.7';
            });
            
            // Hide all delete buttons
            const deleteButtons = document.querySelectorAll('button[onclick*="deleteRow"]');
            deleteButtons.forEach(btn => {
                btn.style.display = 'none';
            });
            
            // Hide "Add Another Product" button
            const addProductBtn = document.querySelector('.add-product-btn');
            if (addProductBtn) {
                addProductBtn.style.display = 'none';
            }
            
            // Hide Action column header and cells
            const actionHeaders = document.querySelectorAll('th.no-print');
            actionHeaders.forEach(th => {
                th.style.display = 'none';
            });
            
            const actionCells = document.querySelectorAll('td.no-print');
            actionCells.forEach(td => {
                td.style.display = 'none';
            });
        }
        
    </script>

</body>
</html>